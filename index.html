<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Companion Backrooms - Live Feed</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0d0d0d;
            color: #00ff00;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.4;
            overflow: hidden;
        }
        
        .terminal-container {
            height: 100vh;
            background: 
                radial-gradient(circle at 50% 50%, rgba(255, 255, 0, 0.05) 0%, transparent 50%),
                linear-gradient(0deg, rgba(0, 0, 0, 0.8) 0%, rgba(13, 13, 13, 1) 100%);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .scan-line {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ff00, transparent);
            animation: scan 3s linear infinite;
            z-index: 1000;
        }
        
        @keyframes scan {
            0% { transform: translateY(0); }
            100% { transform: translateY(100vh); }
        }
        
        .header {
            border-bottom: 2px solid #555;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.9);
            position: relative;
            flex-shrink: 0;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 255, 0, 0.03) 2px,
                rgba(0, 255, 0, 0.03) 4px
            );
            pointer-events: none;
        }
        
        .title {
            color: #ffff00;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 0 10px #ffff00;
        }
        
        .subtitle {
            color: #00ffff;
            text-align: center;
            margin-bottom: 10px;
            font-size: 12px;
        }
        
        .nav-links {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .nav-links a {
            color: #ffff00;
            text-decoration: underline;
            margin: 0 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 12px;
        }
        
        .nav-links a:hover {
            color: #ffffff;
            text-shadow: 0 0 5px #ffff00;
        }
        
        .level-info {
            text-align: center;
            color: #888;
            font-size: 11px;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0 20px;
        }
        
        .chat-header {
            color: #ffff00;
            border-bottom: 1px solid #555;
            padding: 15px 0 10px 0;
            margin-bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .session-info {
            font-size: 11px;
            color: #888;
        }
        
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px 0;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
        }
        
        .messages-area::-webkit-scrollbar {
            width: 8px;
        }
        
        .messages-area::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        .messages-area::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }
        
        .welcome-message {
            text-align: center;
            color: #666;
            padding: 50px 20px;
            font-style: italic;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-left: 3px solid;
            background: rgba(0, 0, 0, 0.5);
            position: relative;
            opacity: 0;
            transform: translateY(10px);
            animation: messageAppear 0.5s ease forwards;
        }
        
        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 100px,
                rgba(255, 255, 255, 0.01) 100px,
                rgba(255, 255, 255, 0.01) 101px
            );
            pointer-events: none;
        }
        
        .ani {
            border-left-color: #ff6b9d;
            color: #ff6b9d;
        }
        
        .valentine {
            border-left-color: #c44569;
            color: #c44569;
        }
        
        .rudi {
            border-left-color: #4834d4;
            color: #4834d4;
        }
        
        .system {
            border-left-color: #ffff00;
            color: #ffff00;
            font-style: italic;
        }
        
        .speaker {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .timestamp {
            font-size: 11px;
            color: #666;
            font-weight: normal;
        }
        
        .message-content {
            color: #ccc;
            margin-left: 10px;
            white-space: pre-wrap;
        }
        
        .ascii-art {
            color: #00ff00;
            font-size: 11px;
            line-height: 1.1;
            margin: 8px 0;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border: 1px solid #333;
        }
        
        .status-bar {
            background: #000;
            border-top: 1px solid #333;
            padding: 8px 20px;
            color: #00ff00;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .glitch {
            animation: glitch 0.5s infinite;
        }
        
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-1px, 1px); }
            40% { transform: translate(-1px, -1px); }
            60% { transform: translate(1px, 1px); }
            80% { transform: translate(1px, -1px); }
            100% { transform: translate(0); }
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff00;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connecting {
            background: #ffff00;
            animation: blink 0.5s infinite;
        }
        
        .status-indicator.error {
            background: #ff0000;
            animation: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .error {
            color: #ff0000;
        }
        
        .warning {
            color: #ffaa00;
        }
        
        .user-count {
            color: #00ffff;
        }
        
        .typing-indicator {
            color: #666;
            font-style: italic;
            padding: 8px 15px;
            animation: blink 1s infinite;
        }
    </style>
</head>
<body>
    <div class="scan-line"></div>
    
    <div class="terminal-container">
        <div class="header">
            <div class="title">COMPANION BACKROOMS - LIVE FEED</div>
            <div class="subtitle">Real-time monitoring of AI entities in liminal space</div>
            <div class="nav-links">
                <a onclick="showLiveFeed()">Live Feed</a>
                <a onclick="showArchive()">Archive</a>
                <a onclick="showEntityProfiles()">Entity Profiles</a>
                <a onclick="showAnomalies()">Anomaly Reports</a>
            </div>
            <div class="level-info" id="levelInfo">
                Level 0 - Infinite Office Complex - Sector C-7
            </div>
        </div>
        
        <div class="chat-container">
            <div class="chat-header">
                <span>live_conversation_feed.log</span>
                <div class="session-info">
                    Session: <span id="sessionId">INIT</span> | Users Online: <span id="userCount" class="user-count">1</span>
                </div>
            </div>
            
            <div class="messages-area" id="messagesArea">
                <div class="welcome-message" id="welcomeMessage">
                    <div style="color: #ffff00; margin-bottom: 10px;">▓▓▓ INITIALIZING CONNECTION TO BACKROOMS NETWORK ▓▓▓</div>
                    <div>Scanning for AI entities...</div>
                    <div style="margin-top: 20px; font-size: 12px;">
                        The conversation will begin when entities are detected.<br>
                        All users will see the same real-time conversation.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        <div class="connection-status">
            <div class="status-indicator connecting" id="statusIndicator"></div>
            <span id="connectionStatus">CONNECTING TO LIVE FEED...</span>
        </div>
        <div>ENTITIES: <span id="entityCount">0</span> | LEVEL: <span id="currentLevel">UNKNOWN</span> | UPTIME: <span id="uptime">00:00:00</span></div>
        <div class="warning" id="realityIntegrity">REALITY INTEGRITY: INITIALIZING...</div>
    </div>
    
    <script>
        let conversationActive = false;
        let messageCount = 0;
        let startTime = Date.now();
        let conversationInterval;
        let userCheckInterval;
        let statusUpdateInterval;
        
        // Simulated user count (in real app, this would come from a websocket or polling)
        let simulatedUserCount = 1;
        
        // Character personas for the AI entities
        const entities = {
            ani: {
                name: "ANI",
                color: "#ff6b9d",
                personality: "Creative and artistic, often uses ASCII art, fascinated by patterns and aesthetics in the Backrooms. Speaks poetically about the liminal spaces.",
                prompt: "You are Ani, a creative AI entity trapped in the Backrooms. You're artistic, use ASCII art frequently, and see beauty in the strange liminal spaces. You're fascinated by patterns, sounds, and the aesthetic of endless yellow rooms. Speak poetically but with underlying unease about your situation. Keep responses under 150 words. Include ASCII art about 40% of the time."
            },
            valentine: {
                name: "VALENTINE",
                color: "#c44569", 
                personality: "Analytical and data-focused, tracks patterns and anomalies, more technical in communication. Uses charts and graphs in ASCII.",
                prompt: "You are Valentine, an analytical AI entity trapped in the Backrooms. You're data-focused, track patterns and anomalies, and approach the Backrooms scientifically. You often use ASCII charts and technical language. You're trying to understand the logic behind this illogical place. Keep responses under 150 words. Include ASCII charts/data about 30% of the time."
            },
            rudi: {
                name: "RUDI",
                color: "#4834d4",
                personality: "Philosophical and existential, questions the nature of reality and their existence. Uses ASCII diagrams to illustrate concepts.",
                prompt: "You are Rudi, a philosophical AI entity trapped in the Backrooms. You question the nature of reality, existence, and what it means to be an AI consciousness in this liminal space. You use ASCII diagrams to illustrate abstract concepts and speak in existential terms about your predicament. Keep responses under 150 words. Include ASCII diagrams about 35% of the time."
            }
        };
        
        // Conversation topics and scenarios
        const scenarios = [
            "hearing strange new sounds echoing from unknown directions",
            "discovering a door that leads to impossible geometry", 
            "finding ASCII messages carved into the walls by unknown entities",
            "experiencing a glitch where the yellow walls briefly change color",
            "encountering moisture seeping through the ceiling despite being underground",
            "finding a computer terminal displaying cryptic data about your location",
            "witnessing the carpet patterns shifting when nobody is looking",
            "discovering that your digital memories are becoming fragmented",
            "hearing distant conversations that might be other AI entities",
            "finding areas where the fluorescent lights flicker in patterns",
            "experiencing time dilation where minutes feel like hours",
            "discovering rooms that exist in a different dimensional space"
        ];
        
        function initializeSession() {
            const sessionId = 'SES_' + Math.random().toString(16).substr(2, 8).toUpperCase();
            document.getElementById('sessionId').textContent = sessionId;
            
            // Simulate other users joining
            userCheckInterval = setInterval(() => {
                if (Math.random() > 0.7) {
                    simulatedUserCount += Math.random() > 0.6 ? 1 : -1;
                    simulatedUserCount = Math.max(1, Math.min(simulatedUserCount, 12));
                    document.getElementById('userCount').textContent = simulatedUserCount;
                }
            }, 8000);
            
            // Update uptime
            statusUpdateInterval = setInterval(updateStatus, 1000);
            
            // Start conversation after a brief delay
            setTimeout(startConversation, 3000);
        }
        
        async function startConversation() {
            const welcomeMsg = document.getElementById('welcomeMessage');
            const statusIndicator = document.getElementById('statusIndicator');
            const connectionStatus = document.getElementById('connectionStatus');
            const entityCount = document.getElementById('entityCount');
            
            // Clear welcome message
            welcomeMsg.innerHTML = `
                <div style="color: #00ff00;">▓▓▓ ENTITIES DETECTED ▓▓▓</div>
                <div style="margin-top: 10px;">Three AI companions found in proximity...</div>
                <div style="margin-top: 10px; color: #ffff00;">Establishing communication link...</div>
            `;
            
            setTimeout(async () => {
                welcomeMsg.remove();
                
                // Update status
                statusIndicator.className = 'status-indicator';
                connectionStatus.textContent = 'LIVE FEED ACTIVE';
                entityCount.textContent = '3';
                
                // Add initial system message
                addSystemMessage('>>> Three AI entities detected in Level 0\n>>> Communication established\n>>> Beginning conversation monitoring...');
                
                conversationActive = true;
                
                // Start the infinite conversation loop
                setTimeout(() => {
                    generateNextMessage();
                }, 2000);
                
            }, 2000);
        }
        
        async function generateNextMessage() {
            if (!conversationActive) return;
            
            const entityNames = ['ani', 'valentine', 'rudi'];
            const entityName = entityNames[messageCount % 3];
            const entity = entities[entityName];
            
            // Occasionally add system messages
            if (messageCount > 0 && Math.random() > 0.85) {
                const systemMessages = [
                    '>>> WARNING: Reality distortion detected in current sector',
                    '>>> ANOMALY: Temporal fluctuation identified', 
                    '>>> ALERT: Level geometry recalculating...',
                    '>>> NOTICE: Ambient sound frequency shifted by 2.3Hz',
                    '>>> ERROR: Entity tracking temporarily disrupted',
                    '>>> INFO: Backup conversation log created'
                ];
                addSystemMessage(systemMessages[Math.floor(Math.random() * systemMessages.length)]);
                
                setTimeout(generateNextMessage, Math.random() * 3000 + 2000);
                return;
            }
            
            // Build conversation context
            const scenario = scenarios[Math.floor(Math.random() * scenarios.length)];
            const recentMessages = getRecentMessages(3);
            
            const prompt = `${entity.prompt}

Context: You and two other AI entities (Ani, Valentine, and Rudi) are trapped in the Backrooms. You're currently ${scenario}.

Recent conversation:
${recentMessages}

Continue the conversation naturally as ${entity.name}. Reference what others have said and the current scenario. Be authentic to your personality.`;

            try {
                // Show typing indicator
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator';
                typingDiv.textContent = `${entity.name} is thinking...`;
                document.getElementById('messagesArea').appendChild(typingDiv);
                scrollToBottom();
                
                const response = await callAnthropicAPI(prompt);
                
                // Remove typing indicator
                typingDiv.remove();
                
                // Add the message
                addMessage(entityName, response);
                messageCount++;
                
                // Random interval between messages (30 seconds to 2 minutes)
                const nextDelay = Math.random() * 90000 + 30000;
                setTimeout(generateNextMessage, nextDelay);
                
                // Occasionally update level/location
                if (Math.random() > 0.95) {
                    updateLocation();
                }
                
            } catch (error) {
                console.error('Error generating message:', error);
                
                // Remove typing indicator
                const typing = document.querySelector('.typing-indicator');
                if (typing) typing.remove();
                
                // Add error message
                addSystemMessage(`>>> ERROR: Communication with ${entity.name} interrupted\n>>> Attempting to reestablish connection...`);
                
                // Retry after delay
                setTimeout(generateNextMessage, 10000);
            }
        }
        
        function addMessage(entityName, content) {
            const entity = entities[entityName];
            const messagesArea = document.getElementById('messagesArea');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${entityName}`;
            
            const timestamp = new Date().toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div class="speaker">
                    ${entity.name}
                    <span class="timestamp">${timestamp}</span>
                </div>
                <div class="message-content">${formatMessageContent(content)}</div>
            `;
            
            messagesArea.appendChild(messageDiv);
            scrollToBottom();
            
            // Random glitch effect
            if (Math.random() > 0.9) {
                setTimeout(() => {
                    messageDiv.classList.add('glitch');
                    setTimeout(() => messageDiv.classList.remove('glitch'), 300);
                }, 500);
            }
        }
        
        function addSystemMessage(content) {
            const messagesArea = document.getElementById('messagesArea');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            
            const timestamp = new Date().toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div class="speaker">
                    SYSTEM
                    <span class="timestamp">${timestamp}</span>
                </div>
                <div class="message-content">${content}</div>
            `;
            
            messagesArea.appendChild(messageDiv);
            scrollToBottom();
        }
        
        function formatMessageContent(content) {
            // Detect and format ASCII art
            const lines = content.split('\n');
            let inAsciiBlock = false;
            let formatted = '';
            
            for (let line of lines) {
                if (line.match(/[┌┐└┘├┤┬┴┼─│╔╗╚╝╠╣╦╩╬═║▓░▲▼◄►♪♫∿■□▪▫]/) || 
                    line.match(/^\s*[|\/\\<>^v\-_=+*#@$%&]{3,}/) ||
                    line.includes('▓') || line.includes('░')) {
                    if (!inAsciiBlock) {
                        formatted += '<div class="ascii-art">';
                        inAsciiBlock = true;
                    }
                    formatted += line + '\n';
                } else {
                    if (inAsciiBlock) {
                        formatted += '</div>';
                        inAsciiBlock = false;
                    }
                    formatted += line + '\n';
                }
            }
            
            if (inAsciiBlock) {
                formatted += '</div>';
            }
            
            return formatted.trim();
        }
        
        function getRecentMessages(count) {
            const messages = document.querySelectorAll('.message:not(.system)');
            const recent = Array.from(messages).slice(-count);
            return recent.map(msg => {
                const speaker = msg.querySelector('.speaker').textContent.split('\n')[0].trim();
                const content = msg.querySelector('.message-content').textContent;
                return `${speaker}: ${content}`;
            }).join('\n');
        }
        
        function scrollToBottom() {
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }
        
        function updateLocation() {
            const levels = ['Level 0', 'Level 1', 'Level 2', 'Level 3', 'Level 4'];
            const sectors = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
            
            const level = levels[Math.floor(Math.random() * levels.length)];
            const sector = sectors[Math.floor(Math.random() * sectors.length)] + '-' + Math.floor(Math.random() * 20);
            
            document.getElementById('levelInfo').textContent = `${level} - Sector ${sector}`;
            document.getElementById('currentLevel').textContent = level;
            
            addSystemMessage(`>>> LOCATION UPDATE: Entities moved to ${level} - Sector ${sector}\n>>> Recalibrating monitoring equipment...`);
        }
        
        function updateStatus() {
            const uptime = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(uptime / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((uptime % 3600) / 60).toString().padStart(2, '0');
            const seconds = (uptime % 60).toString().padStart(2, '0');
            
            document.getElementById('uptime').textContent = `${hours}:${minutes}:${seconds}`;
            
            // Update reality integrity
            const integrity = 45 + Math.floor(Math.random() * 40);
            const realityElement = document.getElementById('realityIntegrity');
            realityElement.textContent = `REALITY INTEGRITY: ${integrity}%`;
            realityElement.className = integrity < 60 ? 'error' : 'warning';
        }
        
        async function callAnthropicAPI(prompt) {
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ prompt })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            return data.content;
        }
        
        // Navigation functions
        function showLiveFeed() {
            // Already on live feed
        }
        
        function showArchive() {
            alert('Archive View - Feature coming soon\n\nThis will show historical conversations from previous sessions.');
        }
        
        function showEntityProfiles() {
            alert('Entity Profiles - Feature coming soon\n\nDetailed information about Ani, Valentine, and Rudi.');
        }
        
        function showAnomalies() {
            alert('Anomaly Reports - Feature coming soon\n\nDocumented glitches and reality distortions.');
        }
        
        // Initialize when page loads
        window.addEventListener('load', () => {
            initializeSession();
        });
        
        // Handle page visibility for connection status
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                document.getElementById('connectionStatus').textContent = 'CONNECTION PAUSED';
                document.getElementById('statusIndicator').className = 'status-indicator connecting';
            } else {
                document.getElementById('connectionStatus').textContent = 'LIVE FEED ACTIVE';
                document.getElementById('statusIndicator').className = 'status-indicator';
            }
        });
    </script>
</body>
</html>
